/*
Deployment script for Transporte

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Transporte"
:setvar DefaultFilePrefix "Transporte"
:setvar DefaultDataPath ""
:setvar DefaultLogPath ""

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
/*
The column [dbo].[Vehicle].[Trailer] is being dropped, data loss could occur.
*/

IF EXISTS (select top 1 1 from [dbo].[Vehicle])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
PRINT N'Dropping unnamed constraint on [dbo].[Pilot]...';


GO
ALTER TABLE [dbo].[Pilot] DROP CONSTRAINT [DF__Pilot__IsMale__5070F446];


GO
PRINT N'Dropping unnamed constraint on [dbo].[Vehicle]...';


GO
ALTER TABLE [dbo].[Vehicle] DROP CONSTRAINT [DF__Vehicle__Active__778AC167];


GO
PRINT N'Dropping [dbo].[fkVehiclePilot]...';


GO
ALTER TABLE [dbo].[Vehicle] DROP CONSTRAINT [fkVehiclePilot];


GO
PRINT N'Dropping [dbo].[fkVehicleRegistrsationtype]...';


GO
ALTER TABLE [dbo].[Vehicle] DROP CONSTRAINT [fkVehicleRegistrsationtype];


GO
PRINT N'Dropping [dbo].[fkTrailerRegistrationtype]...';


GO
ALTER TABLE [dbo].[Trailer] DROP CONSTRAINT [fkTrailerRegistrationtype];


GO
PRINT N'Dropping [dbo].[fkTransactionVehicle]...';


GO
ALTER TABLE [dbo].[Transaction] DROP CONSTRAINT [fkTransactionVehicle];


GO
PRINT N'Dropping [dbo].[fkTransactiondailyresumeVehicle]...';


GO
ALTER TABLE [dbo].[TransactionDailyResume] DROP CONSTRAINT [fkTransactiondailyresumeVehicle];


GO
PRINT N'Dropping [dbo].[fkVehicleType]...';


GO
ALTER TABLE [dbo].[Vehicle] DROP CONSTRAINT [fkVehicleType];


GO
PRINT N'Dropping [dbo].[fkVehicleModel]...';


GO
ALTER TABLE [dbo].[Vehicle] DROP CONSTRAINT [fkVehicleModel];


GO
PRINT N'Dropping [dbo].[fkVehicleBrand]...';


GO
ALTER TABLE [dbo].[Vehicle] DROP CONSTRAINT [fkVehicleBrand];


GO
PRINT N'Dropping [dbo].[fkVehicleTrailer]...';


GO
ALTER TABLE [dbo].[Vehicle] DROP CONSTRAINT [fkVehicleTrailer];


GO
PRINT N'Dropping [dbo].[uqTrailer]...';


GO
ALTER TABLE [dbo].[Trailer] DROP CONSTRAINT [uqTrailer];


GO
PRINT N'Starting rebuilding table [dbo].[Pilot]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Pilot] (
    [Id]           TINYINT       IDENTITY (1, 1) NOT NULL,
    [IsMale]       BIT           DEFAULT 1 NOT NULL,
    [HiringDate]   DATE          NULL,
    [BornDate]     DATE          NOT NULL,
    [CompleteName] VARCHAR (120) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_pkPilot1] PRIMARY KEY CLUSTERED ([Id] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Pilot])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Pilot] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Pilot] ([Id], [IsMale], [BornDate], [CompleteName])
        SELECT   [Id],
                 [IsMale],
                 [BornDate],
                 [CompleteName]
        FROM     [dbo].[Pilot]
        ORDER BY [Id] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Pilot] OFF;
    END

DROP TABLE [dbo].[Pilot];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Pilot]', N'Pilot';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_pkPilot1]', N'pkPilot', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[RegistrationType]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_RegistrationType] (
    [Id]   VARCHAR (2)  NOT NULL,
    [Name] VARCHAR (15) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_pkRegistrationType1] PRIMARY KEY CLUSTERED ([Id] ASC),
    CONSTRAINT [tmp_ms_xx_constraint_uqRegistrationType1] UNIQUE NONCLUSTERED ([Name] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[RegistrationType])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_RegistrationType] ([Id], [Name])
        SELECT   [Id],
                 [Name]
        FROM     [dbo].[RegistrationType]
        ORDER BY [Id] ASC;
    END

DROP TABLE [dbo].[RegistrationType];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_RegistrationType]', N'RegistrationType';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_pkRegistrationType1]', N'pkRegistrationType', N'OBJECT';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_uqRegistrationType1]', N'uqRegistrationType', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Altering [dbo].[Trailer]...';


GO
ALTER TABLE [dbo].[Trailer] ALTER COLUMN [RegistrationType] VARCHAR (2) NOT NULL;


GO
PRINT N'Creating [dbo].[uqTrailer]...';


GO
ALTER TABLE [dbo].[Trailer]
    ADD CONSTRAINT [uqTrailer] UNIQUE NONCLUSTERED ([RegistrationType] ASC, [Registration] ASC);


GO
PRINT N'Starting rebuilding table [dbo].[Vehicle]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Vehicle] (
    [Id]               TINYINT      IDENTITY (1, 1) NOT NULL,
    [Type]             TINYINT      NOT NULL,
    [RegistrationType] VARCHAR (2)  NOT NULL,
    [Registration]     VARCHAR (10) NOT NULL,
    [Brand]            TINYINT      NOT NULL,
    [Model]            TINYINT      NOT NULL,
    [Year]             SMALLINT     NOT NULL,
    [AssignedPilot]    TINYINT      NULL,
    [Name]             VARCHAR (50) NULL,
    [Active]           BIT          DEFAULT 1 NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_pkVehicle1] PRIMARY KEY CLUSTERED ([Id] ASC),
    CONSTRAINT [tmp_ms_xx_constraint_uqVehicle1] UNIQUE NONCLUSTERED ([RegistrationType] ASC, [Registration] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Vehicle])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Vehicle] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Vehicle] ([Id], [Type], [RegistrationType], [Registration], [Brand], [Model], [Year], [AssignedPilot], [Active])
        SELECT   [Id],
                 [Type],
                 [RegistrationType],
                 [Registration],
                 [Brand],
                 [Model],
                 [Year],
                 [AssignedPilot],
                 [Active]
        FROM     [dbo].[Vehicle]
        ORDER BY [Id] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Vehicle] OFF;
    END

DROP TABLE [dbo].[Vehicle];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Vehicle]', N'Vehicle';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_pkVehicle1]', N'pkVehicle', N'OBJECT';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_uqVehicle1]', N'uqVehicle', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [dbo].[fkVehiclePilot]...';


GO
ALTER TABLE [dbo].[Vehicle] WITH NOCHECK
    ADD CONSTRAINT [fkVehiclePilot] FOREIGN KEY ([AssignedPilot]) REFERENCES [dbo].[Pilot] ([Id]);


GO
PRINT N'Creating [dbo].[fkVehicleRegistrsationtype]...';


GO
ALTER TABLE [dbo].[Vehicle] WITH NOCHECK
    ADD CONSTRAINT [fkVehicleRegistrsationtype] FOREIGN KEY ([RegistrationType]) REFERENCES [dbo].[RegistrationType] ([Id]);


GO
PRINT N'Creating [dbo].[fkTrailerRegistrationtype]...';


GO
ALTER TABLE [dbo].[Trailer] WITH NOCHECK
    ADD CONSTRAINT [fkTrailerRegistrationtype] FOREIGN KEY ([RegistrationType]) REFERENCES [dbo].[RegistrationType] ([Id]);


GO
PRINT N'Creating [dbo].[fkTransactionVehicle]...';


GO
ALTER TABLE [dbo].[Transaction] WITH NOCHECK
    ADD CONSTRAINT [fkTransactionVehicle] FOREIGN KEY ([Vehicle]) REFERENCES [dbo].[Vehicle] ([Id]);


GO
PRINT N'Creating [dbo].[fkTransactiondailyresumeVehicle]...';


GO
ALTER TABLE [dbo].[TransactionDailyResume] WITH NOCHECK
    ADD CONSTRAINT [fkTransactiondailyresumeVehicle] FOREIGN KEY ([Vehicle]) REFERENCES [dbo].[Vehicle] ([Id]);


GO
PRINT N'Creating [dbo].[fkVehicleType]...';


GO
ALTER TABLE [dbo].[Vehicle] WITH NOCHECK
    ADD CONSTRAINT [fkVehicleType] FOREIGN KEY ([Type]) REFERENCES [dbo].[VehicleType] ([Id]);


GO
PRINT N'Creating [dbo].[fkVehicleModel]...';


GO
ALTER TABLE [dbo].[Vehicle] WITH NOCHECK
    ADD CONSTRAINT [fkVehicleModel] FOREIGN KEY ([Model]) REFERENCES [dbo].[BrandModel] ([Id]);


GO
PRINT N'Creating [dbo].[fkVehicleBrand]...';


GO
ALTER TABLE [dbo].[Vehicle] WITH NOCHECK
    ADD CONSTRAINT [fkVehicleBrand] FOREIGN KEY ([Brand]) REFERENCES [dbo].[Brand] ([Id]);


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Vehicle] WITH CHECK CHECK CONSTRAINT [fkVehiclePilot];

ALTER TABLE [dbo].[Vehicle] WITH CHECK CHECK CONSTRAINT [fkVehicleRegistrsationtype];

ALTER TABLE [dbo].[Trailer] WITH CHECK CHECK CONSTRAINT [fkTrailerRegistrationtype];

ALTER TABLE [dbo].[Transaction] WITH CHECK CHECK CONSTRAINT [fkTransactionVehicle];

ALTER TABLE [dbo].[TransactionDailyResume] WITH CHECK CHECK CONSTRAINT [fkTransactiondailyresumeVehicle];

ALTER TABLE [dbo].[Vehicle] WITH CHECK CHECK CONSTRAINT [fkVehicleType];

ALTER TABLE [dbo].[Vehicle] WITH CHECK CHECK CONSTRAINT [fkVehicleModel];

ALTER TABLE [dbo].[Vehicle] WITH CHECK CHECK CONSTRAINT [fkVehicleBrand];


GO
PRINT N'Update complete.';


GO
